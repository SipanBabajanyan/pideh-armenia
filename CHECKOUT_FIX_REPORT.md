# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
21 —Å–µ–Ω—Ç—è–±—Ä—è 2024

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ—Å—Ç–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Å–∏—Å—Ç–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É:
```
Failed to create order
at handleSubmit (src/app/checkout/page.tsx:155:15)
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
- –û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `handleSubmit` –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ checkout
- API –º–∞—Ä—à—Ä—É—Ç `/api/orders` –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ API —Ç—Ä–µ–±–æ–≤–∞–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **API –º–∞—Ä—à—Ä—É—Ç —Ç—Ä–µ–±–æ–≤–∞–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**: –í `src/app/api/orders/route.ts` –±—ã–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (!session)` —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –æ—à–∏–±–∫–∏ 401
2. **–°—Ö–µ–º–∞ –ë–î –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∞ –≥–æ—Å—Ç–µ–≤—ã–µ –∑–∞–∫–∞–∑—ã**: –ü–æ–ª–µ `userId` –≤ —Ç–∞–±–ª–∏—Ü–µ `orders` –±—ã–ª–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º (NOT NULL)
3. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**: Frontend –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –≥–æ—Å—Ç–µ–≤—ã–µ –∑–∞–∫–∞–∑—ã, –Ω–æ backend –∏—Ö –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–ª

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª**: `prisma/schema.prisma`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```prisma
model Order {
  id            String      @id @default(cuid())
  userId        String?     // –°–¥–µ–ª–∞–ª–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –¥–ª—è –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  user          User?       @relation(fields: [userId], references: [id]) // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å
}
```

**–ú–∏–≥—Ä–∞—Ü–∏—è**: `20250921133728_make_userid_optional_for_guest_orders`

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API –º–∞—Ä—à—Ä—É—Ç–∞
**–§–∞–π–ª**: `src/app/api/orders/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –£–±—Ä–∞–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –î–æ–±–∞–≤–∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (userId = null)
- –î–æ–±–∞–≤–∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–æ–±–∞–≤–∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–ª—è `deliveryTime`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∏ –≥–æ—Å—Ç–µ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
const order = await prisma.order.create({
  data: {
    userId: session?.user?.id || null, // null –¥–ª—è –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    name: name || 'Guest Customer',
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  }
})
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
1. **–ì–æ—Å—Ç–µ–≤—ã–µ –∑–∞–∫–∞–∑—ã —Ä–∞–±–æ—Ç–∞—é—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Ñ–æ—Ä–º–ª—è—Ç—å –∑–∞–∫–∞–∑—ã –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã —Ä–∞–±–æ—Ç–∞—é—Ç**: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Ñ–æ—Ä–º–ª—è—Ç—å –∑–∞–∫–∞–∑—ã
3. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–ª—è –ª—É—á—à–µ–π –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—É–¥—É—â–µ–º
4. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ deliveryTime**: –ü–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–µ–ª: –≥–æ—Å—Ç–µ–≤–æ–π –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å `userId = null`
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –∑–∞–∫–∞–∑–∞

## –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è

### 1. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –ë–î –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç—É API
- **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è**: –í–µ–¥–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—Ö–µ–º–µ –ë–î
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**: –£–±–µ–∂–¥–∞—Ç—å—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ API –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ API

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –ë–î —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- –°–æ–∑–¥–∞–Ω –¥–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

## –§–∞–π–ª—ã, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

1. `prisma/schema.prisma` - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
2. `src/app/api/orders/route.ts` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API –º–∞—Ä—à—Ä—É—Ç–∞
3. `prisma/migrations/20250921133728_make_userid_optional_for_guest_orders/migration.sql` - –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

## –°—Ç–∞—Ç—É—Å
‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê** - –°–∏—Å—Ç–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞.
